<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>MedAlert</title>
	
  <link rel="stylesheet" type="text/css" href="styles.css" media="screen" />
</head>
<body>
  <!-- Tela inicial: botão para conectar -->
<div id="conectarSection" class="active">
  <h1>Conectar ao ESP32 via Bluetooth</h1>
  <p id="status">Clique no botão para conectar ao dispositivo Bluetooth.</p>
  <button id="btnConectar">Conectar</button>
</div>

<!-- Tela progCaixa: mostra após conexão -->
<div id="progCaixa">
  <h1>Caixa de Remédios Conectada</h1>
  <p id="statusProg">Conectado ao dispositivo BLE.</p>
  <div id="dataHora">--/--/---- --:--:--</div>
  <button id="btnDesconectar" style="margin-top:20px;">Desconectar</button>
</div>

<script>
  let device;

  // Função para mostrar data e hora local atualizada a cada segundo
  function atualizarDataHora() {
    const agora = new Date();
    const dia = String(agora.getDate()).padStart(2, '0');
    const mes = String(agora.getMonth() + 1).padStart(2, '0');
    const ano = agora.getFullYear();
    const horas = String(agora.getHours()).padStart(2, '0');
    const minutos = String(agora.getMinutes()).padStart(2, '0');
    const segundos = String(agora.getSeconds()).padStart(2, '0');
    document.getElementById('dataHora').innerText = `${dia}/${mes}/${ano} ${horas}:${minutos}:${segundos}`;
  }

  setInterval(atualizarDataHora, 1000);
  atualizarDataHora();

  // Mostra uma "tela" e oculta outra
  function mostrarTela(telaId) {
    document.getElementById('conectarSection').classList.remove('active');
    document.getElementById('progCaixa').classList.remove('active');
    document.getElementById(telaId).classList.add('active');
  }

  // Inicia mostrando tela de conexão
  mostrarTela('conectarSection');

  // Botão conectar
  document.getElementById('btnConectar').addEventListener('click', async () => {
    try {
      const options = {
        filters: [{ namePrefix: 'ESP32' }],
        optionalServices: ['4fafc201-1fb5-459e-8fcc-c5c9c331914b']
      };

      device = await navigator.bluetooth.requestDevice(options);

      device.addEventListener('gattserverdisconnected', () => {
        alert('Dispositivo desconectado! Voltando para a tela inicial.');
        mostrarTela('conectarSection');
      });

      const server = await device.gatt.connect();

      document.getElementById('statusProg').innerText = `Conectado ao dispositivo BLE: ${device.name}`;

      mostrarTela('progCaixa');

    } catch (error) {
      document.getElementById('status').innerText = `Erro ao conectar: ${error}`;
    }
  });

  // Botão desconectar
  document.getElementById('btnDesconectar').addEventListener('click', async () => {
    if (device && device.gatt.connected) {
      await device.gatt.disconnect();
      mostrarTela('conectarSection');
      document.getElementById('status').innerText = 'Desconectado manualmente.';
    }
  });
</script>
</body>
</html>
